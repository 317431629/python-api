Getting Started
######################################

Overview
========

The Shotgun API allows users to integrate their tools with Shotgun very easily. Using the simple Python-based API we provide, you can quickly get your scripts integrated with Shotgun's CRUD-based API. Because the needs of every studio can prove to be very different, we don't do a lot of "automation" or "smarts" in our API. We have kept it pretty low-level and leave most of those decisions to you. The API is powerful enough you can write your own "smarts" in a wrapper on top of the Shotgun API.

CRUD
----

The API follows the CRUD pattern allowing simple Create, Read, Update, and Delete actions. Each request acts on a single entity type and depending on the specific action, can define filters, columns to return, sorting information, and some additional options.

Media Files
-----------

The API has additional methods for managing thumbnails, images, and both uploaded and linked media.

Authentication
--------------

In order to communicate with the Shotgun server via the API, your script must be registered with Shotgun and have a valid API key. Then authentication is simple. You just provide your script name and it's API key. We strongly recommend you register each script separately and have individual API keys for each. This allows you to track down each of your scripts and the actions they are performing much more accurately in the event logs.




Setting Up Shotgun for API Access
=================================

Before writing scripts to interact with the Shotgun API, you need to create add a script entity in Shotgun. This will automatically generate an application key which will act as the script's password. The key will look something like this: "bc29517b4928b8336e007ae48e71f082eb0e7c88". To create a new key, click the + button on the "Scripts" page in the Admin section:

.. image:: images/scripts_page.png


Why have different application keys for different scripts?
----------------------------------------------------------

We recommend you create a new key for each script so you can log what scripts are doing what in case one of them causes problems. This will also allow you to better see what scripts are performing what actions in the EventLog. We've found that even though you may think you'll probably never need to know, an extra 2 minutes of setup now can prevent hours of headache in the future.

Permissions
-----------
Script users are bound restrictions of their permission role, which is edited on the script record in the "Permission Role" field. The default permission role for all scripts is "API Admin User" which allows full access to create, update, and delete entities and fields, including editing the "date created" audit field and creating event log entries. If you have other permission roles for ApiUsers, you can set the default role that will be assigned when a new script is created, in the site preferences.

Event Logging
-------------

By default, events generated by scripts using an application key are logged in Shotgun's event log. You can turn this off by unchecking the "Generate Events" checkbox either in the script detail page or from the main Scripts admin page. Note that this will also prevent any email notifications from being triggered by your scripts since the email notifier relies on the event log to find events to notify for.

Why would you want to turn logging off?
---------------------------------------

It is an optimization that is not used often, but some clients have integration scripts that are pushing data into Shotgun just for reference, like publishes from their asset management system. This publish data is never changed later, so the data itself has the entire history, and the events would just clutter the event log.




API Usage Tips
==============

Below is a list of helpful tips when using the Shotgun API. We have tried to make the API very simple to use with predictable results while remaining a powerful tool to integrate with your pipeline. However, there's always a couple of things that crop up that our users might not be aware of. Those are the types of things you'll find below. We'll be adding to this document over time as new questions come up from our users that exhibit these types of cases.

Entity Fields
-------------

When you do a `find()` that returns a field of type entity or multi-entity (for example the 'assets' column on Shot), the entities are returned in a standard hash (dict) format::

    {'type':'Asset', 'name':'redBall', 'id':1}

For each entity returned, you will get a ``'type'``, ``'name'``, and ``'id'`` key. This does not mean there are fields named ``'type'`` and ``'name'`` on the Asset. This is only used to provide a consistent way to represent entities returned via the API.

- ``type``: the entity type (CamelCase)
- ``name``: the display name of the entity. For most entity types this is the field named ``code`` but not always. For example, on the Ticket and Delivery entities the name key would contain the value of the ``title`` field.

Shotgun UI fields not available via the API
-------------------------------------------

Summary type fields like Query Fields and Pipeline Step summary fields are currently only available via the UI. Some other fields may not work as expected through the API because they are "display only" fields made available for convenience and are only available in the browser UI.

HumanUser
.........

- ``name``: This is a UI-only field that is a combination of the ``'firstname' + ' ' + 'lastname'``.

Shot
....

**Smart Cut Fields**: These fields are available only in the browser UI. You can read more about smart cut fields and the API in the Smart Cut Fields doc (link TK).::

    smart_cut_in
    smart_cut_out
    smart_cut_duration
    smart_cut_summary_display
    smart_duration_summary_display
    smart_head_in
    smart_head_out
    smart_head_duration
    smart_tail_in
    smart_tail_out
    smart_tail_duration
    smart_working_duration


Pipeline Step summary fields on entities
........................................

The Pipeline Step summary fields on entities that have Tasks aren't currently available via the API and are calculated on the client side in the UI. These fields are like ``step_0``, or ``step_13``. Note that the Pipeline Step entity itself is available via the API as the entity type ``Step``.

Query Fields
............

Query fields are also summary fields like Pipeline Steps, the query is run from the client side UI and therefore is not currently supported in the API.


Audit Fields
------------
You can set the ``created_by`` and ``created_at`` fields via the API at creation time. This is often useful for when you're importing or migrating data from another source and want to keep the history in tact. However, you cannot set the ``updated_by`` and ``updated_at`` fields. These are automatically set whenever an entity is created or updated.

Logging
-------

The API uses standard python logging but does not define a handler.

To see the logging output in stdout, define a streamhandler in your script::

    import logging
    import shotgun_api3 as shotgun
    logging.basicConfig(level=logging.DEBUG)

To write logging output from the shotgun API to a file, define a file handler in your script::

    import logging
    import shotgun_api3 as shotgun
    logging.basicConfig(level=logging.DEBUG, filename='/path/to/your/log')

To suppress the logging output from the API in a script which uses logging, set the level of the shotgun logger to a higher level::

    import logging
    import shotgun_api3 as shotgun
    sg_log = logging.getLogger('shotgun_api3')
    sg_log.setLevel(logging.ERROR)

IronPython
----------

We do not test against IronPython and cannot be sure that we won't introduce breaking changes or that we will be compatible with future releases of IronPython. While we don't officially support IronPython, we certainly will do our best to figure out any issues that come up while using it and how to avoid them.

As of July 9, 2015 you can look at this fork of the repo to see what changes were needed as of that date to make things work. The original fork was as of v3.0.20 of the API. Big thanks to our awesome clients Pixomondo for making their work public and letting us refer to it:

https://github.com/Pixomondo/python-api/tree/v3.0.20.ipy

v3.0.20 can be used with IronPython with a little bit of added work:

- The Python API uses the zlib module to handle decompressing the gzipped response from the server. There's no built-in zlib module in IronPython, but there's a potential solution from Jeff Hardy at https://bitbucket.org/jdhardy/ironpythonzlib/src/. And the blog post about it here http://blog.jdhardy.ca/2008/12/solving-zlib-problem-ironpythonzlib.html

- If you encounter any SSL errors like ``unknown field: SERIALNUMBER=0123456789`` or ``:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed``. For now you can workaround this problem by disabling ssl certificate validation which we've encountered some intermittent issues with. In the block ~ln 70 of ``shotgun.py``, force ``NO_SSL_VALIDATION = True`` for either case.

- If you encounter ``LookupError: unknown encoding: idna``, you can force utf-8 by changing iri2uri.py ~ln 71 from ``authority = authority.encode('idna')`` to ``authority = authority.encode('utf-8')``

- If you encounter an SSL error such as ``SSL3_READ_BYTES:sslv3 alert handshake failure``, then the lower level SSL library backing python's network infrastructure is attempting to connect to our servers via SSLv3, which is no longer supported. You can use the code from this gist to force the SSL connections to use a specific protocol. The forked repo linked above has an example of how to do that to force the use of TLSv1.




Shotgun Server API Changelog
============================

:note: This list is out of date and has not been updated since 5/2014

The following is a list of changes in the Shotgun server code that affect the API. These are not changes in the Python API code, rather fixes/changes to the Shotgun server's API interface that may affect behavior. Generally changes to the Shotgun server API code are ensured to be non-breaking and backwards compatible bug fixes and feature enhancements. This is to ensure your scripts will not unexpectedly break when updating.

These updates should also appear on the general Release Notes pages but are provided here for convenience.

Format: **[Shotgun server version]**: Description of change made. [internal ticket #]

- **[5.3.15]**: Added filtering out Archived projects. [25082]
- **[5.3.12]**: Added support for api sudo as user. [19989]
- **[5.1.22]**: Added followers, follow, and unfollow methods to code handling api requests. [20562]
- **[3.3.1]**: Modified CRUD code so that if a request reads, sorts, or summarizes a join (ConnectionEntity) field, and the parent entity has not been passed in the request, the code will try to infer it from the filter conditions. Prior to this fix on 3.3 - the API was returning an error when trying to sort Versions on playlists.PlaylistVersionConnection.sg_sort_order. Note that if the parent entity cannot be inferred automatically, this error will still occur. [17107]
- **[3.3.0]**: Added support for returning the full paths of thumbnail fields in regular api calls. This works for thumbnail fields on the entity, linked thumbnails, and filmstrip thumbnails. [10693]
- **[3.0.0]**: We've released v3.08 of the Python API which now includes a JSON backend. The JSON transport is up to 40% faster than the XML-RPC based transport. The XML-RPC interface will continue to be supported but may not include new features, so previous versions of the API will still be supported as-is.
- **[3.0.0]**: Added support for name_is filter operator on single and multi-entity fields, both in the API and the UI.
- **[2.4.8]**: Added support for id inquery filters in the API. The syntax is slightly different than similar filters, in that the filter value is not an array. [14261]
- **[2.4.6]**: Fixed issue with multi-entity field filters where Python None was passed in. Prior to this fix, one could not use the api to create filters such as "['task_assignees', 'is', None]" or "['task_assignees', 'is_not', None]", without generating an api error. These filters are now allowed, and work as expected. [14111]
- **[2.4.0]**: Added query builder and API support for next/previous modifiers for the ""in calendar period"" filter operators for date and datetime fields. For example, "find tasks that were created in the last 7 months..."
- **[2.4.0]**: Ensured that the UI and the API disallow configuring Note Links field to allow the Task or Note entity type.
- **[2.4.0]**: Date fields now require YYYY-MM-DD format. Previously they were documented as requiring that format, but would actually allow other date formats if the server was able to parse them into a valid date.
- **[2.3.9]**: Ensured that creating a task (via the API) with ONLY the duration set - if that task is created with an upstream task that has an end date - results in the created task having both its Start and Due date set by the task dependency logic. [13407]
- **[2.3.7]**: Ensured api parity with UI in terms of passing in filters on linked fields more than 1 link away. [12867]
- **[2.3.7]**: Ensured that api errors are not thrown when creating/updating a task with milestone=True, and start date=end date. This behavior is true when using create(), update(), or either method with batch(). Also, added a unit test to cover this. [13318]
- **[2.3.5]**: Added api support for getting Shotgun's version and build number. Usage requires Shotgun Wrapper version 3.0.6 or higher.
- **[2.3.3]**: Fixed bug with api where local file paths for windows mount points were being double-escaped, resulting in "\" character sequences. [13119]
- **[2.2.5]**: Ensured that api calls requesting summary fields do not result in silent logging on errors to production.log. This fix results in no change for api programmers, but does ensure that such api calls can occur without the possibility of killing apache due to unwieldy and unnecessary logging. [12850]
- **[2.2.4]**: Ensured that creating a Task Template Task through the api doesn't require a project id - unlike creating a non template task. [11283]
- **[2.2.4]**: Fixed error generated when trying to revive a Script (ApiUser) via the API [12794]
- **[2.0.0]**: Added the ability to link to local files via the API.
- **[2.1.2]**: Enforced uniqueness on Script Names (API_user class) so that when creating scripts, the naming conflicts will no longer be allowed. [11479]
- **[2.1.0]**: added a revive() method in the API. Syntax follows that of delete()
- **[2.0.8]**: Disallowed retired scripts from authenticating via the api. The main Shotgun method wills till return a valid Shotgun instance, but any other method calls will return the following error...shotgun.Fault: [11480]
- **[2.0.0]**: Provided API support for layout_project for project creation. Functionality mirrors the web interface: omitting layout_project creates the project based on template project. Supplying layout_project ensures that the new project is based on the supplied project. This fixes the problem of script-created projects having no pages - since they lacked a template, implicit or explicit.
- **[2.0.0]**: Improved API error message resulting when trying to set the default_value property on non status list fields, using schema_field_create().
- **[2.0.0]**: Removed legacy support for sg_system_task_type. Now, all API methods should use Pipeline Steps instead.
- **[2.0.0]**: ended support for API v2 (API2)